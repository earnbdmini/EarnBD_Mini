<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earn Pro</title>

    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Poppins', sans-serif; background-color: #0f0f0f; color: #ffffff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; user-select: none; }
        .gold-gradient { background: linear-gradient(135deg, #FFD700 0%, #FDB931 50%, #d4af37 100%); color: #000; }
        .gold-text { background: linear-gradient(to right, #FFD700, #FDB931); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        #main-app { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; scrollbar-width: none; }
        .nav-container { display: flex; justify-content: space-around; align-items: center; height: 100%; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; color: #6b7280; }
        .nav-item.active { color: #FFD700; transform: scale(1.05); }
        .custom-input { width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: white; padding: 12px; border-radius: 12px; margin-bottom: 10px; }
        select.custom-input option { background: #1a1a1a; color: white; }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#0f0f0f]">
        <h2 class="text-2xl font-bold gold-text tracking-widest">LOADING...</h2>
        <div id="error-box" class="hidden mt-4 text-center">
            <p class="text-red-500 mb-2">Connection Issue</p>
            <button onclick="location.reload()" class="bg-white/10 px-4 py-2 rounded text-white">Retry</button>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="hidden fixed inset-0 z-40 bg-[#0f0f0f] flex flex-col items-center justify-center p-6">
        <div class="mb-8 text-center"><h1 class="text-4xl font-bold gold-text">EARN PRO</h1></div>
        <div class="glass-panel p-6 rounded-2xl w-full max-w-sm">
            <!-- Tabs -->
            <div class="flex mb-6 bg-white/5 rounded-lg p-1">
                <button onclick="toggleAuth('login')" id="tab-login" class="flex-1 py-2 rounded-md text-sm font-bold bg-[#FFD700] text-black">Login</button>
                <button onclick="toggleAuth('signup')" id="tab-signup" class="flex-1 py-2 rounded-md text-sm font-bold text-gray-400">Register</button>
            </div>
            
            <!-- Inputs -->
            <div id="auth-form">
                <input type="number" id="auth-phone" placeholder="Phone Number" class="custom-input">
                <input type="password" id="auth-pass" placeholder="Password" class="custom-input">
                
                <div id="signup-fields" class="hidden">
                    <input type="text" id="auth-name" placeholder="Full Name" class="custom-input">
                    <input type="number" id="auth-ref" placeholder="Referral Code (Optional)" class="custom-input">
                </div>

                <button id="auth-btn" onclick="submitAuth()" class="w-full py-3 rounded-xl gold-gradient text-black font-bold mt-2 shadow-lg active:scale-95 transition-transform">LOGIN</button>
            </div>
        </div>
    </div>

    <!-- APP HEADER -->
    <header class="glass-panel border-b-0 rounded-b-3xl p-4 z-40 shrink-0 hidden" id="app-header">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img id="user-photo" src="" class="w-11 h-11 rounded-full border-2 border-[#FFD700] p-0.5">
                <div><h3 id="user-name" class="font-bold text-md text-white">...</h3><span class="text-[10px] text-gray-400 bg-white/10 px-2 py-0.5 rounded-full">VIP Member</span></div>
            </div>
            <div class="text-right">
                <p class="text-[9px] text-gray-400 uppercase mb-1">Balance</p>
                <div class="bg-[#FFD700]/10 px-3 py-1 rounded-lg border border-[#FFD700]/20"><span id="user-balance" class="text-xl font-bold text-white">0</span></div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <div id="main-app" class="hidden"></div>

    <!-- BOTTOM NAV -->
    <nav class="glass-panel rounded-t-3xl pb-4 pt-3 z-50 shrink-0 h-20 hidden" id="app-nav">
        <div class="nav-container">
            <div onclick="router('home')" class="nav-item active" id="btn-home"><i class="fas fa-home text-xl"></i><span>Home</span></div>
            <div onclick="router('tasks')" class="nav-item" id="btn-tasks"><i class="fas fa-list-check text-xl"></i><span>Tasks</span></div>
            <div onclick="router('wallet')" class="nav-item" id="btn-wallet"><i class="fas fa-wallet text-xl"></i><span>Wallet</span></div>
            <div onclick="router('history')" class="nav-item" id="btn-history"><i class="fas fa-history text-xl"></i><span>History</span></div>
            <div onclick="router('refer')" class="nav-item" id="btn-refer"><i class="fas fa-users text-xl"></i><span>Refer</span></div>
        </div>
    </nav>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // 1. CONFIGURATION
        const SUPABASE_URL = 'https://wnmwvbeydsrehtsnkfoc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubXd2YmV5ZHNyZWh0c25rZm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMDg4MzIsImV4cCI6MjA3OTg4NDgzMn0.4vSObxBEr8r11-dqkp9y6bVroMVoSTEnIOTF8Vo8sxk';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let appSettings = {};
        let adFuncs = { interstitial: null, rewarded: null, popup: null };
        let authMode = 'login';
        const REQUIRED_TIME = 15000;

        function getDeviceFingerprint() { return 'DEV-' + navigator.userAgent.replace(/\D+/g, '').substring(0, 12); }

        // 2. INITIALIZATION
        async function initApp() {
            try {
                const { data: s, error } = await supabase.from('settings').select('*').single();
                
                if (error || !s) {
                    console.log("Settings error, using defaults");
                    appSettings = { 
                        conversion_rate: 1, 
                        min_withdraw_amount: 20, 
                        monetag_direct_link: 'https://google.com',
                        payment_methods: ["Bkash Personal"]
                    };
                } else {
                    appSettings = s;
                }

                if(appSettings.monetag_interstitial_id) loadAdScript(appSettings.monetag_interstitial_id, 'interstitial');
                if(appSettings.monetag_rewarded_id) loadAdScript(appSettings.monetag_rewarded_id, 'rewarded');

                const uid = localStorage.getItem('user_id');
                if (uid) await fetchUser(uid);
                else showAuth();

                const params = new URLSearchParams(window.location.search);
                if (params.get('ref')) { toggleAuth('signup'); document.getElementById('auth-ref').value = params.get('ref'); }

            } catch (e) {
                console.error(e);
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('error-box').classList.remove('hidden');
            }
        }

        // 3. AUTH LOGIC
        function showAuth() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
        }

        function toggleAuth(mode) {
            authMode = mode;
            const login = document.getElementById('tab-login');
            const signup = document.getElementById('tab-signup');
            const extra = document.getElementById('signup-fields');
            const btn = document.getElementById('auth-btn');
            
            if(mode === 'login') {
                login.className = "flex-1 py-2 rounded-md text-sm font-bold bg-[#FFD700] text-black transition";
                signup.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-400 transition";
                extra.classList.add('hidden');
                btn.innerText = "LOGIN";
            } else {
                signup.className = "flex-1 py-2 rounded-md text-sm font-bold bg-[#FFD700] text-black transition";
                login.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-400 transition";
                extra.classList.remove('hidden');
                btn.innerText = "REGISTER";
            }
        }

        async function submitAuth() {
            const phoneVal = document.getElementById('auth-phone').value;
            const pass = document.getElementById('auth-pass').value;
            
            if(!phoneVal || !pass) return Swal.fire('Error', 'Fill all fields', 'warning');
            if(phoneVal.length !== 11) return Swal.fire('Error', 'Invalid Phone Number', 'warning');

            const phone = parseInt(phoneVal);
            Swal.showLoading();

            try {
                if(authMode === 'login') {
                    const { data, error } = await supabase.from('users').select('*').eq('id', phone).eq('password', pass).single();
                    Swal.close();
                    
                    if(data) {
                        localStorage.setItem('user_id', data.id);
                        location.reload();
                    } else {
                        Swal.fire('Error', 'Invalid credentials', 'error');
                    }
                } else {
                    const name = document.getElementById('auth-name').value;
                    const refVal = document.getElementById('auth-ref').value;
                    if(!name) return Swal.fire('Error', 'Enter Name', 'warning');

                    const { data: res, error } = await supabase.rpc('handle_new_user', {
                        p_phone: phone,
                        p_pass: pass,
                        p_name: name,
                        p_referrer: refVal ? parseInt(refVal) : null,
                        p_device_id: getDeviceFingerprint()
                    });
                    Swal.close();

                    if(res && res.success) {
                        localStorage.setItem('user_id', phone);
                        location.reload();
                    } else {
                        Swal.fire('Failed', res?.message || error?.message, 'error');
                    }
                }
            } catch(e) {
                Swal.close();
                Swal.fire('Error', 'Network Error', 'error');
            }
        }

        async function fetchUser(uid) {
            const { data } = await supabase.from('users').select('*').eq('id', uid).single();
            if(data) {
                currentUser = data;
                updateUI();
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('app-header').classList.remove('hidden');
                document.getElementById('app-nav').classList.remove('hidden');
                router('home');
            } else {
                localStorage.removeItem('user_id');
                location.reload();
            }
        }

        // 4. TASK LOGIC
        document.addEventListener("visibilitychange", async () => {
            if (document.visibilityState === "visible") {
                const start = localStorage.getItem('t_start');
                const tid = localStorage.getItem('t_id');
                const rew = localStorage.getItem('t_rew');

                if(start && tid) {
                    const diff = Date.now() - parseInt(start);
                    if(diff >= REQUIRED_TIME) {
                        await addPoints(tid, rew);
                    } else {
                        Swal.fire({icon: 'error', title: 'Task Failed', text: `Stay 15s. You stayed ${(diff/1000).toFixed(1)}s`, confirmButtonColor: '#FFD700'});
                    }
                    localStorage.removeItem('t_start'); localStorage.removeItem('t_id'); localStorage.removeItem('t_rew');
                }
            }
        });

        window.handleTask = (tid, rew, type, link) => {
            if(type === 'direct_ad' || type === 'offer_wheel') {
                const url = (link && link !== 'null') ? link : appSettings.monetag_direct_link;
                if(!url) return Swal.fire('Error', 'No Link', 'error');

                localStorage.setItem('t_start', Date.now());
                localStorage.setItem('t_id', tid);
                localStorage.setItem('t_rew', rew);

                window.open(url, '_blank');
                Swal.fire({title: 'Wait 15s', text: 'Do not close tab', timer: 3000, showConfirmButton: false});
            }
            else if(type === 'video') {
                if(adFuncs.rewarded) {
                    adFuncs.rewarded().then(() => addPoints(tid, rew)).catch(() => Swal.fire('Failed', 'Watch full ad', 'error'));
                } else {
                    Swal.fire('Loading', 'Ad not ready', 'warning');
                }
            }
            else {
                if(link) window.open(link, '_blank');
                setTimeout(() => addPoints(tid, rew), 5000);
            }
        };

        async function addPoints(tid, rew) {
            Swal.fire({title: 'Adding...', didOpen: () => Swal.showLoading()});
            const { data: res, error } = await supabase.rpc('claim_task', {
                p_user_id: parseInt(currentUser.id), p_task_id: parseInt(tid),
                p_reward: parseFloat(rew), p_limit: parseInt(appSettings.daily_task_limit)
            });
            Swal.close();

            if(res && res.success) {
                currentUser.balance += parseFloat(rew);
                updateUI();
                Swal.fire({icon: 'success', title: `+${rew} Points`, timer: 1500, showConfirmButton: false});
                router('tasks');
            } else {
                Swal.fire('Failed', res?.message, 'warning');
            }
        }

        // 5. WITHDRAW
        async function processWithdraw() {
            const num = document.getElementById('w-num').value;
            const amtVal = document.getElementById('w-amt').value;
            const method = document.getElementById('w-method').value;

            if(!num || !amtVal) return Swal.fire('Error', 'Empty fields', 'warning');

            const amt = parseFloat(amtVal);
            const pts = parseFloat((amt / appSettings.conversion_rate).toFixed(2));

            if(amt < appSettings.min_withdraw_amount) return Swal.fire('Error', `Min ${appSettings.min_withdraw_amount} TK`, 'warning');
            if(currentUser.balance < pts) return Swal.fire('Error', `Need ${pts} Points`, 'error');

            const { data: res, error } = await supabase.rpc('process_withdrawal', {
                p_user_id: parseInt(currentUser.id), p_method: method,
                p_number: num, p_amount_bdt: amt, p_points_needed: pts
            });

            if(res && res.success) {
                currentUser.balance -= pts;
                updateUI();
                Swal.fire('Success', 'Request Sent', 'success');
                router('history');
            } else {
                Swal.fire('Error', res?.message || error?.message, 'error');
            }
        }

        // 6. UI
        function loadAdScript(zoneId, type) {
            const s = document.createElement('script');
            s.src = '//libtl.com/sdk.js'; s.dataset.zone = zoneId; s.dataset.sdk = 'show_' + zoneId;
            s.onload = () => adFuncs[type] = window['show_' + zoneId];
            document.head.appendChild(s);
        }

        function updateUI() {
            if(!currentUser) return;
            document.getElementById('user-name').innerText = currentUser.first_name;
            document.getElementById('user-balance').innerText = Math.floor(currentUser.balance);
            document.getElementById('user-photo').src = `https://ui-avatars.com/api/?name=${currentUser.first_name}&background=random`;
        }

        function router(page) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('text-[#FFD700]'));
            document.getElementById('btn-'+page).classList.add('text-[#FFD700]');
            
            const c = document.getElementById('main-app');
            if(page === 'home') renderHome(c);
            else if(page === 'tasks') renderTasks(c);
            else if(page === 'wallet') renderWallet(c);
            else if(page === 'history') renderHistory(c);
            else if(page === 'refer') renderRefer(c);
        }

        function renderHome(c) {
            c.innerHTML = `
            <div class="glass-panel p-6 rounded-3xl text-center mt-4 border-t border-white/10">
                <h1 class="text-5xl font-bold text-white mb-2">${Math.floor(currentUser.balance)}</h1>
                <p class="text-xs text-[#FFD700] tracking-widest">POINTS</p>
                <button onclick="router('tasks')" class="mt-6 w-full py-3 rounded-xl gold-gradient text-black font-bold">START WORK</button>
            </div>
            ${appSettings.home_banner_url ? `<img src="${appSettings.home_banner_url}" class="w-full h-32 object-cover rounded-xl mt-4 border border-white/10">` : ''}`;
        }

        async function renderTasks(c) {
            c.innerHTML = `<div class="flex justify-center mt-20"><div class="loader"></div></div>`;
            const { data: tasks } = await supabase.from('tasks').select('*').eq('is_active', true).order('id');
            const { data: logs } = await supabase.from('task_logs').select('task_id').eq('user_id', currentUser.id).eq('created_at', new Date().toISOString().split('T')[0]);
            
            const counts = {}; if(logs) logs.forEach(l => counts[l.task_id] = (counts[l.task_id] || 0) + 1);
            const limit = appSettings.daily_task_limit;

            let html = `<div class="space-y-4 mt-4 pb-20">`;
            tasks.forEach(t => {
                const done = counts[t.id] || 0;
                const disabled = done >= limit;
                let icon = t.task_type === 'video' ? 'play-circle' : 'globe';
                
                html += `
                <div class="glass-panel p-4 rounded-xl flex justify-between items-center ${disabled ? 'opacity-50' : ''}">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center text-[#FFD700]"><i class="fas fa-${icon}"></i></div>
                        <div><h4 class="font-bold text-white">${t.title}</h4><span class="text-xs text-[#FFD700]">+${t.reward} â€¢ ${done}/${limit}</span></div>
                    </div>
                    <button onclick="handleTask(${t.id}, ${t.reward}, '${t.task_type}', '${t.link}')" ${disabled?'disabled':''} class="px-5 py-2 rounded-lg bg-[#FFD700] text-black font-bold text-xs">${disabled ? 'Done' : 'Start'}</button>
                </div>`;
            });
            c.innerHTML = html + `</div>`;
        }

        function renderWallet(c) {
            let opts = ''; 
            if(appSettings.payment_methods) appSettings.payment_methods.forEach(m => opts += `<option value="${m}">${m}</option>`);
            
            c.innerHTML = `
            <div class="glass-panel p-6 rounded-2xl text-center mt-4">
                <h1 class="text-4xl font-bold text-white">\u09F3 ${(currentUser.balance * appSettings.conversion_rate).toFixed(2)}</h1>
                <p class="text-xs text-gray-400">Min: ${appSettings.min_withdraw_amount} TK</p>
            </div>
            <div class="space-y-4 mt-6">
                <select id="w-method" class="custom-input">${opts}</select>
                <input type="number" id="w-num" placeholder="Number" class="custom-input">
                <input type="number" id="w-amt" placeholder="Amount" class="custom-input">
                <button onclick="processWithdraw()" class="w-full py-3 rounded-xl gold-gradient text-black font-bold">WITHDRAW</button>
            </div>`;
        }

        async function renderRefer(c) {
            const link = `${location.origin}${location.pathname}?ref=${currentUser.id}`;
            const { data: refers } = await supabase.from('users').select('first_name, created_at').eq('referred_by', currentUser.id);
            
            let hist = '';
            if(refers) refers.forEach(u => hist += `<div class="flex justify-between p-2 bg-white/5 rounded mb-1"><span class="text-xs">${u.first_name}</span><span class="text-[10px] text-gray-400">${new Date(u.created_at).toLocaleDateString()}</span></div>`);

            c.innerHTML = `
            <div class="glass-panel p-6 rounded-2xl text-center mt-4 border border-[#FFD700]/30">
                <h2 class="text-2xl font-bold text-white">Refer & Earn</h2>
                <p class="text-xs text-gray-400 mt-2">Bonus: ${appSettings.referral_bonus} Points</p>
            </div>
            <div class="glass-panel p-3 rounded-xl mt-6 flex items-center gap-2 bg-black/30">
                <input type="text" value="${link}" readonly class="bg-transparent text-xs w-full text-white" id="ref-link">
                <button onclick="navigator.clipboard.writeText('${link}'); Swal.fire('Copied', '', 'success')" class="p-2 bg-[#FFD700] rounded text-black"><i class="fas fa-copy"></i></button>
            </div>
            <div class="mt-4"><h3 class="text-sm font-bold mb-2">My Referrals (${refers?refers.length:0})</h3>${hist}</div>`;
        }

        function renderHistory(c) {
            c.innerHTML = `<div class="text-center mt-10"><div class="loader"></div></div>`;
            supabase.from('withdrawals').select('*').eq('user_id', currentUser.id).order('created_at', {ascending:false})
            .then(({data}) => {
                let html = `<div class="space-y-3 mt-4">`;
                if(!data || data.length === 0) html = `<div class="text-center text-gray-500 mt-20">Empty</div>`;
                else data.forEach(i => {
                    html += `<div class="glass-panel p-4 rounded-xl flex justify-between items-center">
                        <div><h4 class="font-bold text-white">\u09F3 ${i.amount_bdt}</h4><p class="text-[10px] text-gray-400">${i.method}</p></div>
                        <span class="text-[10px] font-bold px-2 py-1 rounded bg-white/10 ${i.status==='paid'?'text-green-400':'text-yellow-400'}">${i.status}</span>
                    </div>`;
                });
                c.innerHTML = html + `</div>`;
            });
        }

        initApp();
    </script>
</body>
</html>
